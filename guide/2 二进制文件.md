# 二进制文件

**大纲**

[TOC]

## 编译原理

* 编译工具

  * `cc1` : 编译器 (Preprocess`hello.i`, Compile`hello.s`) 
  * `as` : 汇编器 (Assemble`hello.o`)
  * `collect2` : 链接器 (Link`hello`)

* 编译过程

  * `Preprocess`

    ```shell
    gcc -E hello.c -o helo.i
    ```
    
  * `Compile`
  
    ```shell
    gcc -S hello.c -o hello.s
    gcc -S hello.i -o hello.s
    ```
  
  * `Assembly`
  
    ```shell
    gcc -c hello.c -o hello.o
    gcc -c hello.s -o hello.o  # hello.o is a relocatable file
    ```
  
  * `Link`
  
    > 1.  gcc 默认使用动态链接
    >
    > 2. 目标文件及其依赖库进行链接，生成可执行文件
    > 3. Address and Storage Allocation, Symbol binding, Relocation
  
    ```shell
    gcc hello.o -o hello -static  # 如果没有-static则是动态链接
    ```

## ELF 文件格式

* Executable and Linkable Format : Unix Lab 作为二进制接口 (Application Binary Interface - `ABI`) 使用
* Linux系统运行的就是ELF格式的文件, 相关定义在 `/usr/include/elf.h` 中
* File Classification
  * 可执行文件 `.exec`
  * 可重定位文件 `.rel` : 常常以`.o`为文件后缀名，用于与其他目标文件进行链接以构成**可执行文件**或**动态链接库**，常为一段位置独立代码 (Position Independent Code, `PIC`)
  * 共享目标文件 `.dyn` : **动态链接库文件**
  * 核心转储文件 `Core Dump file` : 进程意外终止时进程地址空间的转储, 也是`ELF`文件的一种。使用`GDB`读取这类文件可以辅助调试和查找程序崩溃的原因
* File Structure
  * `ELF`统称为`Object file` (与`.o` (统称为**可重定位文件**) 不同)
  * 视角
    * 链接视角(based on **Section**)
      * `ELF Header` : 文件头
      * `.text` : 可执行机器指令
      * `.data` : **已初始化**的：全局变量, 局部静态变量
      * `.bss` : **未初始化**的：全局变量, 局部静态变量
    * 运行视角(based on **Segment**)

## 静态链接



## 动态链接











